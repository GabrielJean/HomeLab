- hosts: linux_vms
  order: sorted
  become: true
  ignore_unreachable: true
  gather_facts: false

  pre_tasks:
    - name: "Check host reachability"
      ansible.builtin.include_tasks: ./Tasks/check_reachability.yml

    - name: "Gather facts"
      ansible.builtin.setup:

  vars_files:
    - vars/secrets.yml

  vars:
    main_user: gabriel
    ci_user: ci
    main_user_authorized_key: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDpRej6BHMw/6qH5zmyzE4mI6skbjSowAeqUPBpOP8sR gabri@Gwebs-PC-1'
    ci_user_authorized_key: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJsHP1ihWUwQOSIrUackHvv5PR9DI3VWHM2cF0Gh6wMA gabriel@Gwebs-PC-1'

  tasks:

    - name: "Ensure package cache is fresh"
      ansible.builtin.apt:
        update_cache: yes
      changed_when: false

    - name: "Install qemu-guest-agent and prometheus-node-exporter"
      ansible.builtin.apt:
        pkg:
          - qemu-guest-agent
          - prometheus-node-exporter
          - curl
        state: present

    - name: "Ensure group 'docker' exists"
      ansible.builtin.group:
        name: docker
        state: present

    - name: "Ensure {{ main_user }} user exists (with sudo and docker groups, bash shell)"
      ansible.builtin.user:
        name: "{{ main_user }}"
        state: present
        shell: /bin/bash
        groups: sudo,docker
        append: yes
        password: >-
          {{ (main_user_password is defined)
             | ternary(main_user_password | password_hash('sha512', main_user_password_salt), omit) }}
        password_lock: "{{ (main_user_password is not defined) | ternary(true, false) }}"

    - name: "Add {{ main_user }} to docker group"
      ansible.builtin.user:
        name: "{{ main_user }}"
        groups: docker
        append: yes

    - name: "Create .ssh directory for {{ main_user }} user"
      ansible.builtin.file:
        path: "/home/{{ main_user }}/.ssh"
        state: directory
        owner: "{{ main_user }}"
        group: "{{ main_user }}"
        mode: '0700'

    - name: "Ensure authorized key is present for {{ main_user }} user"
      ansible.posix.authorized_key:
        user: "{{ main_user }}"
        state: present
        key: "{{ main_user_authorized_key }}"

    - name: "Allow 'sudo' group to have passwordless sudo"
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%sudo'
        line: '%sudo ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'

    - name: "Ensure {{ ci_user }} user exists (with sudo and docker groups, bash shell)"
      ansible.builtin.user:
        name: "{{ ci_user }}"
        state: present
        shell: /bin/bash
        groups: sudo,docker
        append: yes
        password: "!"
        password_lock: true

    - name: "Create .ssh directory for {{ ci_user }} user"
      ansible.builtin.file:
        path: "/home/{{ ci_user }}/.ssh"
        state: directory
        owner: "{{ ci_user }}"
        group: "{{ ci_user }}"
        mode: '0700'

    - name: "Ensure authorized key is present for {{ ci_user }} user"
      ansible.posix.authorized_key:
        user: "{{ ci_user }}"
        state: present
        key: "{{ ci_user_authorized_key }}"

    - name: "Set permissions for the home directory of {{ ci_user }} user"
      ansible.builtin.file:
        path: "/home/{{ ci_user }}"
        state: directory
        owner: "{{ ci_user }}"
        group: "{{ ci_user }}"
        mode: '0755'

    - name: "Install ZSH"
      ansible.builtin.apt:
        name: zsh
        state: present

    - name: "Check if prezto directory exists for {{ main_user }}"
      ansible.builtin.stat:
        path: "/home/{{ main_user }}/.zprezto"
      register: prezto_dir
      become: false

    - name: "Clone prezto if it doesn't exist"
      shell: >
        zsh -c 'git clone --recursive https://github.com/sorin-ionescu/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"'
      args:
        chdir: "/home/{{ main_user }}"
      when:
        - prezto_dir is defined
        - prezto_dir.stat is defined
        - prezto_dir.stat.exists == False
      become: false

    - name: "Set up prezto runcoms"
      shell: >
        zsh -c 'setopt EXTENDED_GLOB;
        for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
          ln -s "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}";
        done'
      args:
        chdir: "/home/{{ main_user }}"
      become: false
      when:
        - prezto_dir is defined
        - prezto_dir.stat is defined
        - prezto_dir.stat.exists == False

    - name: "Enable bash completion in ~/.zshrc"
      ansible.builtin.lineinfile:
        path: "/home/{{ main_user }}/.zshrc"
        line: "autoload -U +X bashcompinit && bashcompinit"
        state: present
        create: yes
      become: false

    - name: "Ensure ~/.local/bin is in PATH for ZSH"
      ansible.builtin.lineinfile:
        path: "/home/{{ main_user }}/.zshrc"
        line: 'export PATH="$PATH:$HOME/.local/bin"'
        state: present
        create: yes
      become: false

    - name: "Install GitHub Copilot CLI for {{ main_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        curl -fsSL https://gh.io/copilot-install | bash
      args:
        executable: /bin/bash
        creates: "/home/{{ main_user }}/.local/bin/copilot"
      environment:
        PREFIX: "/home/{{ main_user }}/.local"
        PATH: "/home/{{ main_user }}/.local/bin:{{ ansible_env.PATH }}"
      become: true
      become_user: "{{ main_user }}"

    - name: "Change default shell to ZSH for {{ main_user }}"
      ansible.builtin.user:
        name: "{{ main_user }}"
        shell: /bin/zsh

    - name: "Vacuum journal logs older than 14 days"
      ansible.builtin.command: journalctl --vacuum-time=14d

    - name: "Set static route for LAN A hosts"
      ansible.builtin.set_fact:
        tailscale_route_to: "192.168.15.0/24"
        tailscale_route_via: "192.168.10.7"
      when: ansible_default_ipv4.address is match('^192\\.168\\.10\\.')

    - name: "Set static route for LAN B hosts"
      ansible.builtin.set_fact:
        tailscale_route_to: "192.168.10.0/24"
        tailscale_route_via: "192.168.15.8"
      when: ansible_default_ipv4.address is match('^192\\.168\\.15\\.')

    - name: "Configure netplan static route for site-to-site"
      ansible.builtin.copy:
        dest: /etc/netplan/99-tailscale-routes.yaml
        owner: root
        group: root
        mode: '0644'
        content: |
          network:
            version: 2
            ethernets:
              {{ ansible_default_ipv4.interface }}:
                routes:
                  - to: {{ tailscale_route_to }}
                    via: {{ tailscale_route_via }}
      when:
        - tailscale_route_to is defined
        - tailscale_route_via is defined

    - name: "Apply netplan"
      ansible.builtin.command: netplan apply
      when:
        - tailscale_route_to is defined
        - tailscale_route_via is defined